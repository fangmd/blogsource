---
title: HTTPS
date: 2016-12-28 13:18:12
tags: [HTTPS]
category: ReadNote

---


# HTTPS 基础

Secure Hypertext Transfer Protocol：安全超文本传输协议

简单的说：是 HTTP 的安全版,是使用 TLS/SSL 加密的 HTTP 协议。

HTTPS = HTTP + TLS/SSL

## TLS/SSL

安全传输层协议 Transport Layer Security

介于 TCP 和 HTTP 之间的一层安全协议

### TLS/SSL 原理

加密功能实现依赖三类基本算法：散列函数 Hash，对称加密，非对称加密。

利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性。

散列函数 Hash：MD5、SHA1、SHA256 。。。
对称加密： AES-CBC、DES、3DES、AES-GCM等，相同的密钥可以用于信息的加密和解密，通信方式是1对1
非对称加密：RSA，ECC，DH等，密钥成对出现，一般称为公钥(公开)和私钥(保密)，公钥加密的信息只能私钥解开，私钥加密的信息只能公钥解开。服务器可以实现1对多的通信

***TLS 的基本工作方式：***客户端使用非对称加密与服务器进行通信，实现身份验证并协商对称加密使用的密钥，然后对称加密算法采用协商密钥对信息以及信息摘要进行加密通信，不同的节点之间采用的对称密钥不同，从而可以保证信息只能通信双方获取。


## PKI 体系
>CA 负责核实公钥的拥有者信息，并颁发认证”证书”，同时能够为使用者提供证书验证服务，即 PKI 体系。

### RSA 身份验证的隐患

身份验证和密钥协商是 TLS 的基础功能，但是这个的前提是合法的服务器掌握对应的私钥。

但是 RSA 算法无法确保服务器身份的合法性，因为公钥不包含服务器的信息，存在安全隐患。

存在的安全隐患：（公钥获取的时候被中间人截获）

```
客户端 C 和服务器 S 进行通信，中间节点 M 截获了二者的通信；

节点 M 自己计算产生一对公钥 pub_M 和私钥 pri_M;

C 向 S 请求公钥时，M 把自己的公钥 pub_M 发给了 C;

C 使用公钥 pub_M 加密的数据能够被 M 解密，因为 M 掌握对应的私钥 pri_M，而 C 无法根据公钥信息判断服务器的身份，从而 C 和 M 之间建立了”可信”加密连接;

中间节点 M 和服务器S之间再建立合法的连接，因此 C 和 S 之间通信被M完全掌握，M 可以进行信息的窃听、篡改等操作。

另外，服务器也可以对自己的发出的信息进行否认，不承认相关信息是自己发出。
```

出现的问题：中间人攻击和信息抵赖。

### 身份验证-CA 和证书

解决中间人攻击的关键是确保获取公钥的途径是合法的，需要能够验证服务器的身份信息，于是引入权威的第三方机构 CA。

CA 负责核实公钥的拥有者信息，并颁发认证”证书”，同时能够为使用者提供证书验证服务，即 PKI 体系。

CA 流程：

![CA 流程](http://mmbiz.qpic.cn/mmbiz/tnZGrhTk4dffpIp6abyRclAF7FIILZI7RwlDmL6kwAT5f5GDnvA8uxFic17NnfwXy0o4A20uggicnVWU5ROmeK0A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)


a.服务方 S 向第三方机构CA提交公钥、组织信息、个人信息(域名)等信息并申请认证；

b.CA 通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等；

c.如信息审核通过，CA 会向申请者签发认证文件-证书。

证书包含以下信息：申请者公钥、申请者的组织信息和个人信息、签发机构 CA 的信息、有效时间、证书序列号等信息的明文，同时包含一个签名；

签名的产生算法：首先，使用散列函数计算公开的明文信息的信息摘要，然后，采用 CA 的私钥对信息摘要进行加密，密文即签名；

d.客户端 C 向服务器 S 发出请求时，S 返回证书文件；

e.客户端 C 读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，然后，利用对应 CA 的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性，即公钥合法；

f.客户端然后验证证书相关的域名信息、有效时间等信息；

g.客户端会内置信任 CA 的证书信息(包含公钥)，如果CA不被信任，则找不到对应 CA 的证书，证书也会被判定非法。

在这个过程注意几点：

a.申请证书不需要提供私钥，确保私钥永远只能服务器掌握；

b.证书的合法性仍然依赖于非对称加密算法，证书主要是增加了服务器信息以及签名；

c.内置 CA 对应的证书称为根证书，颁发者和使用者相同，自己为自己签名，即自签名证书；

d.证书=公钥+申请者与颁发者信息+签名；


### 证书链



### 证书吊销

主要存在两类机制：CRL 与 OCSP。


# HTTPS 性能与优化

HTTPS 原理与优势：身份验证、信息加密与完整性校验等，且未对 TCP 和 HTTP 协议做任何修改。

劣势：

1. 增加延时
2. 消耗较多的 CPU 资源

## HTTPS 接入优化

1. CDN 接入
2. 会话缓存
3. 硬件加速
4. 远程解密
5. SPDY/HTTP2



参考：

- [http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&mid=402615812&idx=1&sn=b6dae639119bb66e7025321254b8d973&scene=1&srcid=122439MA3l7gRwfjgNOB76pA#rd](http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&mid=402615812&idx=1&sn=b6dae639119bb66e7025321254b8d973&scene=1&srcid=122439MA3l7gRwfjgNOB76pA#rd)